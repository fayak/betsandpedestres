{{define "bet_show"}}
  {{template "base" .}}
{{end}}

{{define "content"}}
  <h1>{{.Content.Title}}</h1>
  <p class="muted">Created by {{if .Content.CreatorUsername}}<a href="/profile/{{.Content.CreatorUsername}}">{{.Content.CreatorName}}</a>{{else}}{{.Content.CreatorName}}{{end}}</p>

  {{if .Content.Description}}
    <p style="white-space:pre-wrap">{{.Content.Description}}</p>
  {{end}}

  {{if .Content.Deadline}}
    <p class="muted">Deadline: <span class="dt" data-iso="{{.Content.Deadline.UTC.Format "2006-01-02T15:04:05Z07:00"}}"></span></p>
  {{end}}

  <h3>Pick an outcome</h3>

<p class="muted">
  Status:
  {{if eq .Content.StatusLabel "Open"}}<span class="pill">Open</span>{{end}}
  {{if eq .Content.StatusLabel "Past the deadline"}}<span class="pill" style="background:#806400; border:1px solid #facc15; color:#000;">Past the deadline</span>{{end}}
  {{if eq .Content.StatusLabel "Waiting for consensus"}}
    <span class="pill" style="background:#f97316; border:1px solid #fb923c">
      Waiting for consensus ‚Äî votes: {{.Content.VotesTotal}} / {{.Content.Quorum}}
    </span>
  {{end}}
  {{if eq .Content.StatusLabel "Waiting for admin decision"}}
    <span class="pill" style="background:#7c2d12; border:1px solid #b91c1c">
      Waiting for an admin decision
    </span>
  {{end}}
  {{if eq .Content.StatusLabel "Closed"}}
    <span class="pill" style="background:#5c1c1c; border:1px solid #e53e3e">
      Closed
    </span>
    {{if .Content.WinningLabel}}
      <span class="pill" style="background:#1f3d2b; border:1px solid #4ade80; margin-left:8px;">
        Winner: {{.Content.WinningLabel}}
      </span>
    {{end}}
  {{end}}
  {{if .Content.MyVoteLabel}}
    <span class="pill" style="background:#1f2937; border:1px solid #4ade80; margin-left:8px;">
      Your vote: {{.Content.MyVoteLabel}}
    </span>
  {{end}}
</p>


{{if .Content.ResolutionMode}}
  <div class="pill" style="background:#1f2937; border:1px solid #b91c1c">
    ‚ö†Ô∏è <b>Moderator action:</b> Selecting the winning outcome will finalize payouts to winners
    once a consensus is reached. Double-check the result and be honest.
  </div>

  <form method="POST" action="/bets/{{.Content.BetID}}/resolve" style="display:grid; gap:16px; max-width:860px; margin-top:12px">
    <div class="opt-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
      {{range .Content.Options}}
        <label class="opt-card" style="border:2px solid {{if .SelectedByMe}}#4ade80{{else}}#b91c1c{{end}}; border-radius:12px; padding:12px; display:block; cursor:pointer; background:linear-gradient(90deg, rgba(44,68,112,0.5) {{.Percent}}%, rgba(15,17,23,0.8) {{.Percent}}%);">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <div style="font-weight:600">{{.Label}}</div>
            <input type="radio" name="option_id" value="{{.ID}}" required>
          </div>
          <div class="row" style="gap:10px; margin-top:6px; flex-wrap:wrap;">
            <span class="pill">ü¶∂ Stakes: {{.Stakes}} PiedPi√®ces</span>
            <span class="pill">Ratio: {{.Ratio}}</span>
          </div>
          {{if .Bettors}}
            <div style="margin-top:8px;">
              <div class="muted" style="margin-bottom:4px">Bettors (by amount):</div>
              <ul style="margin:0; padding-left:18px;">
                {{range .Bettors}}
                  <li>{{if .Username}}<a href="/profile/{{.Username}}">{{.Name}}</a>{{else}}{{.Name}}{{end}} ‚Äî {{.Amount}}</li>
                {{end}}
              </ul>
            </div>
          {{end}}
        </label>
      {{end}}
    </div>

    <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap;">
      <button class="primary" style="background:{{if .Content.PastDeadline}}#ef4444{{else}}#4b5563{{end}}; cursor:{{if .Content.PastDeadline}}pointer{{else}}not-allowed{{end}}" {{if not .Content.PastDeadline}}disabled title="You can only resolve once the deadline has passed."{{end}}>Confirm outcome</button>
      <a class="pill" href="/bets/{{.Content.BetID}}">Cancel</a>
      {{if not .Content.PastDeadline}}
        <span class="muted">You can resolve once the bet deadline is over.</span>
      {{end}}
    </div>
  </form>

{{else}}
  {{if and .Content.IsModerator .Content.WaitingForAdmin}}
    <div class="pill" style="background:#3f1d1d; border:1px solid #b91c1c; margin-bottom:12px;">
      Voting is locked because moderators disagree. Please escalate to an admin.
    </div>
  {{end}}

  <form id="wagerForm" method="POST" action="/bets/{{.Content.BetID}}/wagers" style="display:grid; gap:16px; max-width:860px">
    <div class="opt-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
      {{range .Content.Options}}
        <label class="opt-card" style="border:2px solid {{if .SelectedByMe}}#4ade80{{else}}#2a2e39{{end}}; border-radius:12px; padding:12px; display:block; cursor:pointer; background:linear-gradient(90deg, rgba(44,68,112,0.5) {{.Percent}}%, rgba(15,17,23,0.8) {{.Percent}}%);">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <div style="font-weight:600">{{.Label}}</div>
            {{if and $.Content.CanWager (not $.Content.AlreadyClosed)}}
              <input type="radio" name="option_id" value="{{.ID}}" required>
            {{end}}
          </div>
          <div class="row" style="gap:10px; margin-top:6px; flex-wrap:wrap;">
            <span class="pill">ü¶∂ Stakes: {{.Stakes}} PiedPi√®ces</span>
            <span class="pill">Ratio: {{.Ratio}}</span>
          </div>
          {{if .Bettors}}
            <div style="margin-top:8px;">
              <div class="muted" style="margin-bottom:4px">Bettors (by amount):</div>
              <ul style="margin:0; padding-left:18px;">
                {{range .Bettors}}
                  <li>{{if .Username}}<a href="/profile/{{.Username}}">{{.Name}}</a>{{else}}{{.Name}}{{end}} ‚Äî {{.Amount}}</li>
                {{end}}
              </ul>
            </div>
          {{else}}
            <div class="muted" style="margin-top:8px;">No wagers yet.</div>
          {{end}}
        </label>
      {{end}}
    </div>

    {{if .Content.ExternalURL}}
      <p><a href="{{.Content.ExternalURL}}" target="_blank" rel="noopener">External link ‚Üó</a></p>
    {{end}}

    {{if and $.Content.CanWager (not $.Content.AlreadyClosed)}}
      <div style="display:grid; gap:10px; max-width:420px; margin-top:8px;">
        <label>
          <div>Amount (max: ü¶∂ <span id="maxStake">{{.Content.MaxStake}}</span> PiedPi√®ces)</div>
          <input id="amount" name="amount" type="number" min="1" max="{{.Content.MaxStake}}" required>
        </label>
        <input type="hidden" name="idempotency_key" id="idemp" value="{{.Content.IdempotencyKey}}">
        <div class="row" style="gap:8px;">
          <button id="submitBtn" class="primary">Place wager</button>
          <a class="pill" href="/bets/{{.Content.BetID}}">Cancel</a>
        </div>
        <p class="muted">Submitting will lock the amount into this bet‚Äôs escrow.</p>
      </div>
    {{else if .Header.LoggedIn}}
      {{if .Content.AlreadyClosed}}
        <p class="muted">This bet is closed.</p>
      {{else if or .Content.WaitingForConsensus .Content.WaitingForAdmin}}
        <p class="muted">Wagering paused while the bet is {{.Content.StatusLabel}}.</p>
      {{else}}
        <p class="muted">You can‚Äôt place a wager right now.</p>
      {{end}}
    {{else}}
      <p class="muted">Please log in to place a wager.</p>
    {{end}}
  {{if and .Content.IsModerator (not .Content.AlreadyClosed)}}
  <div class="row" style="margin:12px 0">
    <a class="pill" style="background:#3b82f6" href="/bets/{{.Content.BetID}}?mode=resolve">Close the bet and select the outcome</a>
  </div>
{{end}}
  </form>
{{end}}
{{if and (eq .Content.StatusLabel "Closed") .Content.Payouts}}
  <h3>Payouts</h3>
  <ul>
    {{range .Content.Payouts}}
      <li>{{if .Username}}<a href="/profile/{{.Username}}">{{.Name}}</a>{{else}}{{.Name}}{{end}} ‚Äî ü¶∂ +{{.Amount}} PiedPi√®ces</li>
    {{end}}
  </ul>
{{end}}

  <div class="row" style="margin-top:12px">
    <a class="pill" href="/bets/new">Create another</a>
    <a class="pill" href="/">Back home</a>
  </div>

  <script>
    // Make clicking the whole card check the radio (label+input already handles it).
    // Enforce max and prevent double-submit.
    (function(){
      const f  = document.getElementById('wagerForm');
      const a  = document.getElementById('amount');
      const b  = document.getElementById('submitBtn');
      if (a && b && f) {
        const mx = parseInt(document.getElementById('maxStake').textContent || '0', 10) || 0;
        a.addEventListener('input', ()=> {
          if (a.value) {
            let v = parseInt(a.value,10)||0;
            if (v > mx) v = mx;
            if (v < 1)  v = 1;
            a.value = v;
          }
        });
        f.addEventListener('submit', (e)=>{
          if (b.dataset.busy === "1") { e.preventDefault(); return; }
          b.dataset.busy = "1"; b.disabled = true;
        });
      }
    })();
  </script>
{{end}}
