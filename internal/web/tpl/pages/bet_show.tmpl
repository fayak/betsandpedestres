{{define "bet_show"}}
  {{template "base" .}}
{{end}}

{{define "content"}}
  <style>
    .bet-title-row {display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; margin-bottom:12px;}
    .resolve-link {background:#451a1a; border:1px solid #fca5a5; color:#fee2e2; padding:10px 16px; border-radius:14px; font-weight:600; text-transform:uppercase; letter-spacing:0.02em; align-self:flex-start; box-shadow:0 0 12px rgba(252,165,165,0.2);}
    .resolve-link:hover {background:#7f1d1d; border-color:#fecaca;}
    .resolve-link.admin-link {background:#0f172a; border-color:#38bdf8; color:#e0f2fe; box-shadow:0 0 12px rgba(56,189,248,0.25);}
    .resolve-link.admin-link:hover {background:#172033; border-color:#7dd3fc;}
    .bet-option-card {transition:background 0.2s ease, border-color 0.2s ease; display:flex; gap:16px; align-items:stretch; border-radius:8px;}
    .bet-option-card.disabled {opacity:0.6; cursor:not-allowed;}
    .opt-main {flex:1; display:flex; flex-direction:column; gap:8px; min-width:0;}
    .opt-radio-wrap {display:flex; align-items:center; justify-content:center; min-width:30px;}
    .bet-radio {appearance:none;-webkit-appearance:none;width:32px;height:32px;min-width: 32px;border-radius:0;border:1px solid #3f4b63;background:#0c1524;box-shadow:0 0 0 1px rgba(148,163,184,0.35);cursor:pointer;transition:box-shadow 0.2s ease, border-color 0.2s ease, background 0.2s ease;}
    .bet-radio:hover:not(:disabled) {border-color:#60a5fa;box-shadow:0 0 12px rgba(96,165,250,0.35);}    
    .bet-radio:checked {background:#1e293b;border-color:#60a5fa;box-shadow:0 0 12px rgba(96,165,250,0.55);}   
    .bet-radio:checked::after {content:"";display:block;width:14px;height:14px;margin-left: -2px;background:#e2e8f0;}
    .bet-radio:focus-visible {outline:none;border-color:#93c5fd;box-shadow:0 0 0 2px rgba(147,197,253,0.35);}   
    .bet-radio:disabled {opacity:0.35; cursor:not-allowed; box-shadow:none; border-color:#475569;}
    .wager-box {background:linear-gradient(135deg,rgba(13,16,26,0.9),rgba(12,13,20,0.85)); border:1px solid #1f2937; border-radius:10px; padding:18px; margin-top:4px; box-shadow:0 15px 35px rgba(0,0,0,0.35);}
    .amount-input-wrap {display:flex; flex-wrap:wrap; gap:16px; align-items:flex-start;}
    .amount-input-wrap input[type="number"] {padding:10px 12px; font-size:1.1rem; border-radius:12px; border:1px solid #475569; background:#0b1120; color:#f8fafc;}
    .wager-slider {width:100%; margin:12px 0; accent-color:#38bdf8;}
    .wager-actions {display:flex; gap:10px; flex-wrap:wrap;}
    @media (max-width:640px){
      .bet-title-row {flex-direction:column; align-items:flex-start;}
      .resolve-link {width:100%; text-align:center;}
      .bet-option-card {flex-direction:column;}
      .opt-radio-wrap {justify-content:flex-start; align-self:flex-start;}
      .wager-actions {flex-direction:column; width:100%;}
      .wager-actions .primary, .wager-actions .pill {width:100%; text-align:center;}
    }
  </style>

  <div class="bet-title-row">
    <div>
      <h1 style="margin-bottom:4px;">{{.Content.Title}}</h1>
      <p class="muted">Created by {{if .Content.CreatorUsername}}<a href="/profile/{{.Content.CreatorUsername}}">{{.Content.CreatorName}}</a>{{else}}{{.Content.CreatorName}}{{end}}</p>
    </div>
    {{if and .Content.IsModerator (not .Content.AlreadyClosed)}}
      <a class="resolve-link" href="/bets/{{.Content.BetID}}?mode=resolve">Close the bet &amp; select the outcome</a>
    {{end}}
  </div>

  {{if .Content.Description}}
    <p style="white-space:pre-wrap">{{.Content.Description}}</p>
  {{end}}

  {{if .Content.ExternalURL}}
    <p class="muted" style="margin-top:-4px;">More context: <a href="{{.Content.ExternalURL}}" target="_blank" rel="noopener">{{.Content.ExternalURL}}</a></p>
  {{end}}

  {{if .Content.Deadline}}
    <p class="muted">Deadline: <span class="dt" data-iso="{{.Content.Deadline.UTC.Format "2006-01-02T15:04:05Z07:00"}}"></span></p>
  {{end}}

  <h3>Pick an outcome</h3>

<p class="muted">
  Status:
  {{if eq .Content.StatusLabel "Open"}}<span class="pill">Open</span>{{end}}
  {{if eq .Content.StatusLabel "Past the deadline"}}<span class="pill" style="background:#806400; border:1px solid #facc15; color:#000;">Past the deadline</span>{{end}}
  {{if eq .Content.StatusLabel "Waiting for consensus"}}
    <span class="pill" style="background:#f97316; border:1px solid #fb923c">
      Waiting for consensus ‚Äî votes: {{.Content.VotesTotal}} / {{.Content.Quorum}}
    </span>
  {{end}}
  {{if eq .Content.StatusLabel "Waiting for admin decision"}}
    <span class="pill" style="background:#7c2d12; border:1px solid #b91c1c">
      Waiting for an admin decision
    </span>
  {{end}}
  {{if eq .Content.StatusLabel "Closed"}}
    <span class="pill" style="background:#5c1c1c; border:1px solid #e53e3e">
      Closed
    </span>
    {{if .Content.WinningLabel}}
      <span class="pill" style="background:#1f3d2b; border:1px solid #4ade80; margin-left:8px;">
        Winner: {{.Content.WinningLabel}}
      </span>
    {{end}}
  {{end}}
  {{if .Content.MyVoteLabel}}
    <span class="pill" style="background:#1f2937; border:1px solid #4ade80; margin-left:8px;">
      Your vote: {{.Content.MyVoteLabel}}
    </span>
  {{end}}
</p>


{{if .Content.ResolutionMode}}
  {{if .Content.AdminOverrideMode}}
    <div class="pill" style="background:#1f2937; border:1px solid #38bdf8">
      üõ°Ô∏è <b>Admin override:</b> You are forcibly selecting the winning outcome. This bypasses moderator votes
      and immediately distributes payouts. Triple-check everything before confirming.
    </div>
  {{else}}
    <div class="pill" style="background:#1f2937; border:1px solid #b91c1c">
      ‚ö†Ô∏è <b>Moderator action:</b> Selecting the winning outcome will finalize payouts to winners
      once a consensus is reached. Double-check the result and be honest.
    </div>
  {{end}}

  <form method="POST" action="/bets/{{.Content.BetID}}/resolve" style="display:grid; gap:16px; max-width:860px; margin-top:12px">
    {{if .Content.AdminOverrideMode}}
      <input type="hidden" name="admin_override" value="1">
    {{end}}
    <div class="opt-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
      {{range .Content.Options}}
        <label class="opt-card bet-option-card" style="border:2px solid {{if .SelectedByMe}}#4ade80{{else}}#b91c1c{{end}}; padding:12px; cursor:pointer; background:linear-gradient(120deg, rgba(54,79,132,0.45) {{.Percent}}%, rgba(15,17,23,0.85) {{.Percent}}%);">
          <div class="opt-main">
            <div style="font-weight:600; color:var(--accent);">{{.Label}}</div>
            <div class="row" style="gap:10px; flex-wrap:wrap;">
              <span class="pill">ü¶∂ Stakes: {{.Stakes}} PiedPi√®ces</span>
              <span class="pill">Ratio: {{.Ratio}}</span>
            </div>
            {{if .Bettors}}
              <div>
                <div class="muted" style="margin-bottom:4px">Bettors (by amount):</div>
                <ul style="margin:0; padding-left:18px;">
                  {{range .Bettors}}
                    <li>{{if .Username}}<a href="/profile/{{.Username}}">{{.Name}}</a>{{else}}{{.Name}}{{end}} ‚Äî {{.Amount}}</li>
                  {{end}}
                </ul>
              </div>
            {{end}}
          </div>
          <div class="opt-radio-wrap">
            <input type="radio" class="bet-radio" name="option_id" value="{{.ID}}" required>
          </div>
        </label>
      {{end}}
    </div>

    <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap;">
      <button class="primary" style="background:{{if .Content.ResolutionAllowed}}#dc2626{{else}}#4b5563{{end}}; cursor:{{if .Content.ResolutionAllowed}}pointer{{else}}not-allowed{{end}}" {{if not .Content.ResolutionAllowed}}disabled{{if .Content.DeadlineDefined}} title="You can only resolve once the deadline has passed."{{end}}{{end}}>
        {{if .Content.AdminOverrideMode}}Force outcome{{else}}Confirm outcome{{end}}
      </button>
      <a class="pill" href="/bets/{{.Content.BetID}}">Cancel</a>
      {{if and (not .Content.ResolutionAllowed) .Content.DeadlineDefined}}
        <span class="muted">You can resolve once the bet deadline is over.</span>
      {{end}}
    </div>
  </form>

{{else}}
  {{if and .Content.IsModerator .Content.WaitingForAdmin}}
    <div class="pill" style="background:#3f1d1d; border:1px solid #b91c1c; margin-bottom:12px;">
      Voting is locked because moderators disagree. Please escalate to an admin.
    </div>
    {{if .Content.IsAdmin}}
      <div class="row" style="margin-bottom:16px;">
        <a class="resolve-link admin-link" href="/bets/{{.Content.BetID}}?mode=admin">Admin: close the bet</a>
      </div>
    {{end}}
  {{end}}

  <form id="wagerForm" method="POST" action="/bets/{{.Content.BetID}}/wagers" style="display:grid; gap:16px; max-width:860px">
    <div class="opt-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
      {{range .Content.Options}}
        <label class="opt-card bet-option-card{{if or (not $.Content.CanWager) $.Content.AlreadyClosed}} disabled{{end}}" style="border:2px solid {{if .SelectedByMe}}#4ade80{{else}}#2a2e39{{end}}; padding:12px; cursor:pointer; background:linear-gradient(120deg, rgba(44,68,112,0.45) {{.Percent}}%, rgba(15,17,23,0.82) {{.Percent}}%);">
          <div class="opt-main">
            <div style="font-weight:600; color:var(--accent);">{{.Label}}</div>
            <div class="row" style="gap:10px; flex-wrap:wrap;">
              <span class="pill">ü¶∂ Stakes: {{.Stakes}} PiedPi√®ces</span>
              <span class="pill">Ratio: {{.Ratio}}</span>
            </div>
            {{if .Bettors}}
              <div>
                <div class="muted" style="margin-bottom:4px">Bettors (by amount):</div>
                <ul style="margin:0; padding-left:18px;">
                  {{range .Bettors}}
                    <li>{{if .Username}}<a href="/profile/{{.Username}}">{{.Name}}</a>{{else}}{{.Name}}{{end}} ‚Äî {{.Amount}}</li>
                  {{end}}
                </ul>
              </div>
            {{else}}
              <div class="muted">No wagers yet.</div>
            {{end}}
          </div>
          <div class="opt-radio-wrap">
            <input type="radio" class="bet-radio" name="option_id" value="{{.ID}}" {{if and $.Content.CanWager (not $.Content.AlreadyClosed)}}required{{else}}disabled{{end}}>
          </div>
        </label>
      {{end}}
    </div>

    {{if and $.Content.CanWager (not $.Content.AlreadyClosed)}}
      <div class="wager-box accent-panel soft">
        <div class="amount-input-wrap">
          <div style="flex:1; min-width:220px;">
            <label for="amount" style="font-weight:600; display:block; margin-bottom:6px;">Amount to wager</label>
            <input id="amount" name="amount" type="number" min="1" max="{{.Content.MaxStake}}" placeholder="ü¶∂ PiedPi√®ces" required>
            <div class="pill info-pill" style="margin-top:8px; display:inline-flex; align-items:center; gap:6px;">
              Max: ü¶∂ <span id="maxStake">{{.Content.MaxStake}}</span> PiedPi√®ces available
            </div>
          </div>
          <div class="wager-actions" style="align-items:flex-start;">
            <button id="submitBtn" class="primary">Place wager</button>
            <a class="pill" href="/bets/{{.Content.BetID}}">Cancel</a>
          </div>
        </div>
        <input type="range" id="amountSlider" class="wager-slider" min="0" max="{{.Content.MaxStake}}" value="0" {{if eq .Content.MaxStake 0}}disabled{{end}}>
        <input type="hidden" name="idempotency_key" id="idemp" value="{{.Content.IdempotencyKey}}">
        <p class="muted" style="margin:4px 0 0;">Use the slider or the field to choose how many ü¶∂ PiedPi√®ces go into escrow.</p>
        {{if eq .Content.MaxStake 0}}
          <p class="muted" style="color:#fca5a5; margin-top:4px;">You currently have no free PiedPi√®ces to wager.</p>
        {{end}}
      </div>
    {{else if .Header.LoggedIn}}
      {{if .Content.AlreadyClosed}}
        <p class="muted">This bet is closed.</p>
      {{else if or .Content.WaitingForConsensus .Content.WaitingForAdmin}}
        <p class="muted">Wagering paused while the bet is {{.Content.StatusLabel}}.</p>
      {{else}}
        <p class="muted">You can‚Äôt place a wager right now.</p>
      {{end}}
    {{else}}
      <p class="muted">Please log in to place a wager.</p>
    {{end}}
  </form>
{{end}}
{{if and (eq .Content.StatusLabel "Closed") .Content.Payouts}}
  <h3>Payouts</h3>
  <ul>
    {{range .Content.Payouts}}
      <li>{{if .Username}}<a href="/profile/{{.Username}}">{{.Name}}</a>{{else}}{{.Name}}{{end}} ‚Äî ü¶∂ +{{.Amount}} PiedPi√®ces</li>
    {{end}}
  </ul>
{{end}}

  <div class="row" style="margin-top:12px">
    <a class="pill" href="/bets/new">Create another</a>
    <a class="pill" href="/">Back home</a>
  </div>

  <script>
    // Make clicking the whole card check the radio (label+input already handles it).
    // Enforce max, sync slider/field, and prevent double-submit.
    (function(){
      const form   = document.getElementById('wagerForm');
      const amount = document.getElementById('amount');
      const submit = document.getElementById('submitBtn');
      const slider = document.getElementById('amountSlider');
      const maxNode = document.getElementById('maxStake');
      const maxVal = parseInt((maxNode && maxNode.textContent) || (amount && amount.max) || (slider && slider.max) || '0', 10) || 0;

      const clamp = (val) => {
        if (!maxVal) {
          return 0;
        }
        if (val > maxVal) return maxVal;
        if (val < 1) return 1;
        return val;
      };

      const setSubmit = (enabled, reason) => {
        if (!submit) return;
        submit.disabled = !enabled;
        if (!enabled && reason) {
          submit.dataset.disabledReason = reason;
          submit.title = reason;
        } else {
          if (submit.dataset.disabledReason) {
            delete submit.dataset.disabledReason;
          }
          submit.removeAttribute('title');
        }
      };

      if (maxVal === 0 && submit) {
        setSubmit(false, 'You have no free ü¶∂ PiedPi√®ces available.');
      }

      if (slider && amount) {
        slider.addEventListener('input', () => {
          if (maxVal === 0) {
            slider.value = '0';
            amount.value = '';
            setSubmit(false, 'You have no free ü¶∂ PiedPi√®ces available.');
            return;
          }
          let val = parseInt(slider.value, 10) || 0;
          if (val === 0) {
            amount.value = '';
            setSubmit(false, 'Move the slider above 0 PiedPi√®ces.');
            return;
          }
          val = clamp(val);
          slider.value = String(val);
          amount.value = String(val);
          setSubmit(true);
        });
      }

      if (amount) {
        amount.addEventListener('input', () => {
          if (maxVal === 0) {
            amount.value = '';
            if (slider) slider.value = '0';
            setSubmit(false, 'You have no free ü¶∂ PiedPi√®ces available.');
            return;
          }
          let val = parseInt(amount.value, 10) || 0;
          if (val <= 0) {
            amount.value = '';
            if (slider) slider.value = '0';
            setSubmit(false, 'Enter at least 1 PiedPi√®ce.');
            return;
          }
          val = clamp(val);
          amount.value = String(val);
          if (slider) slider.value = String(val);
          setSubmit(true);
        });
      }

      if (form && submit) {
        form.addEventListener('submit', (e)=>{
          if (submit.dataset.busy === "1") { e.preventDefault(); return; }
          submit.dataset.busy = "1";
          submit.disabled = true;
        });
      }
    })();
  </script>
{{end}}
