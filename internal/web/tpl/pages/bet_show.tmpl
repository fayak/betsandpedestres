{{define "bet_show"}}
  {{template "base" .}}
{{end}}

{{define "content"}}
  <style>
    .bet-title-row {display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; margin-bottom:12px;}
    .resolve-link {background:#451a1a; border:1px solid #fca5a5; color:#fee2e2; padding:10px 16px; border-radius:14px; font-weight:600; text-transform:uppercase; letter-spacing:0.02em; align-self:flex-start; box-shadow:0 0 12px rgba(252,165,165,0.2);}
    .resolve-link:hover {background:#7f1d1d; border-color:#fecaca;}
    .bet-option-card {transition:background 0.2s ease, border-color 0.2s ease;}
    .bet-option-card input.bet-radio {width:22px; height:22px; accent-color:#f97316; cursor:pointer;}
    .bet-option-card.disabled {opacity:0.6; cursor:not-allowed;}
    .wager-box {background:linear-gradient(180deg,#0f172a,#111827); border:1px solid #1f2937; border-radius:18px; padding:18px; margin-top:4px; box-shadow:0 10px 30px rgba(0,0,0,0.35);}
    .amount-input-wrap {display:flex; flex-wrap:wrap; gap:16px; align-items:flex-start;}
    .amount-input-wrap input[type="number"] {padding:10px 12px; font-size:1.1rem; border-radius:12px; border:1px solid #475569; background:#0b1120; color:#f8fafc; min-width:140px;}
    .wager-slider {width:100%; margin:12px 0; accent-color:#38bdf8;}
    .wager-actions {display:flex; gap:10px; flex-wrap:wrap;}
  </style>

  <div class="bet-title-row">
    <div>
      <h1 style="margin-bottom:4px;">{{.Content.Title}}</h1>
      <p class="muted">Created by {{if .Content.CreatorUsername}}<a href="/profile/{{.Content.CreatorUsername}}">{{.Content.CreatorName}}</a>{{else}}{{.Content.CreatorName}}{{end}}</p>
    </div>
    {{if and .Content.IsModerator (not .Content.AlreadyClosed)}}
      <a class="resolve-link" href="/bets/{{.Content.BetID}}?mode=resolve">Close the bet &amp; select the outcome</a>
    {{end}}
  </div>

  {{if .Content.Description}}
    <p style="white-space:pre-wrap">{{.Content.Description}}</p>
  {{end}}

  {{if .Content.Deadline}}
    <p class="muted">Deadline: <span class="dt" data-iso="{{.Content.Deadline.UTC.Format "2006-01-02T15:04:05Z07:00"}}"></span></p>
  {{end}}

  <h3>Pick an outcome</h3>

<p class="muted">
  Status:
  {{if eq .Content.StatusLabel "Open"}}<span class="pill">Open</span>{{end}}
  {{if eq .Content.StatusLabel "Past the deadline"}}<span class="pill" style="background:#806400; border:1px solid #facc15; color:#000;">Past the deadline</span>{{end}}
  {{if eq .Content.StatusLabel "Waiting for consensus"}}
    <span class="pill" style="background:#f97316; border:1px solid #fb923c">
      Waiting for consensus ‚Äî votes: {{.Content.VotesTotal}} / {{.Content.Quorum}}
    </span>
  {{end}}
  {{if eq .Content.StatusLabel "Waiting for admin decision"}}
    <span class="pill" style="background:#7c2d12; border:1px solid #b91c1c">
      Waiting for an admin decision
    </span>
  {{end}}
  {{if eq .Content.StatusLabel "Closed"}}
    <span class="pill" style="background:#5c1c1c; border:1px solid #e53e3e">
      Closed
    </span>
    {{if .Content.WinningLabel}}
      <span class="pill" style="background:#1f3d2b; border:1px solid #4ade80; margin-left:8px;">
        Winner: {{.Content.WinningLabel}}
      </span>
    {{end}}
  {{end}}
  {{if .Content.MyVoteLabel}}
    <span class="pill" style="background:#1f2937; border:1px solid #4ade80; margin-left:8px;">
      Your vote: {{.Content.MyVoteLabel}}
    </span>
  {{end}}
</p>


{{if .Content.ResolutionMode}}
  <div class="pill" style="background:#1f2937; border:1px solid #b91c1c">
    ‚ö†Ô∏è <b>Moderator action:</b> Selecting the winning outcome will finalize payouts to winners
    once a consensus is reached. Double-check the result and be honest.
  </div>

  <form method="POST" action="/bets/{{.Content.BetID}}/resolve" style="display:grid; gap:16px; max-width:860px; margin-top:12px">
    <div class="opt-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
      {{range .Content.Options}}
        <label class="opt-card bet-option-card" style="border:2px solid {{if .SelectedByMe}}#4ade80{{else}}#b91c1c{{end}}; border-radius:12px; padding:12px; display:block; cursor:pointer; background:linear-gradient(90deg, rgba(44,68,112,0.5) {{.Percent}}%, rgba(15,17,23,0.8) {{.Percent}}%);">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <div style="font-weight:600">{{.Label}}</div>
            <input type="radio" class="bet-radio" name="option_id" value="{{.ID}}" required>
          </div>
          <div class="row" style="gap:10px; margin-top:6px; flex-wrap:wrap;">
            <span class="pill">ü¶∂ Stakes: {{.Stakes}} PiedPi√®ces</span>
            <span class="pill">Ratio: {{.Ratio}}</span>
          </div>
          {{if .Bettors}}
            <div style="margin-top:8px;">
              <div class="muted" style="margin-bottom:4px">Bettors (by amount):</div>
              <ul style="margin:0; padding-left:18px;">
                {{range .Bettors}}
                  <li>{{if .Username}}<a href="/profile/{{.Username}}">{{.Name}}</a>{{else}}{{.Name}}{{end}} ‚Äî {{.Amount}}</li>
                {{end}}
              </ul>
            </div>
          {{end}}
        </label>
      {{end}}
    </div>

    <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap;">
      <button class="primary" style="background:{{if .Content.ResolutionAllowed}}#dc2626{{else}}#4b5563{{end}}; cursor:{{if .Content.ResolutionAllowed}}pointer{{else}}not-allowed{{end}}" {{if not .Content.ResolutionAllowed}}disabled{{if .Content.DeadlineDefined}} title="You can only resolve once the deadline has passed."{{end}}{{end}}>Confirm outcome</button>
      <a class="pill" href="/bets/{{.Content.BetID}}">Cancel</a>
      {{if and (not .Content.ResolutionAllowed) .Content.DeadlineDefined}}
        <span class="muted">You can resolve once the bet deadline is over.</span>
      {{end}}
    </div>
  </form>

{{else}}
  {{if and .Content.IsModerator .Content.WaitingForAdmin}}
    <div class="pill" style="background:#3f1d1d; border:1px solid #b91c1c; margin-bottom:12px;">
      Voting is locked because moderators disagree. Please escalate to an admin.
    </div>
  {{end}}

  <form id="wagerForm" method="POST" action="/bets/{{.Content.BetID}}/wagers" style="display:grid; gap:16px; max-width:860px">
    <div class="opt-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
      {{range .Content.Options}}
        <label class="opt-card bet-option-card{{if or (not $.Content.CanWager) $.Content.AlreadyClosed}} disabled{{end}}" style="border:2px solid {{if .SelectedByMe}}#4ade80{{else}}#2a2e39{{end}}; border-radius:12px; padding:12px; display:block; cursor:pointer; background:linear-gradient(90deg, rgba(44,68,112,0.5) {{.Percent}}%, rgba(15,17,23,0.8) {{.Percent}}%);">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <div style="font-weight:600">{{.Label}}</div>
            {{if and $.Content.CanWager (not $.Content.AlreadyClosed)}}
              <input type="radio" class="bet-radio" name="option_id" value="{{.ID}}" required>
            {{end}}
          </div>
          <div class="row" style="gap:10px; margin-top:6px; flex-wrap:wrap;">
            <span class="pill">ü¶∂ Stakes: {{.Stakes}} PiedPi√®ces</span>
            <span class="pill">Ratio: {{.Ratio}}</span>
          </div>
          {{if .Bettors}}
            <div style="margin-top:8px;">
              <div class="muted" style="margin-bottom:4px">Bettors (by amount):</div>
              <ul style="margin:0; padding-left:18px;">
                {{range .Bettors}}
                  <li>{{if .Username}}<a href="/profile/{{.Username}}">{{.Name}}</a>{{else}}{{.Name}}{{end}} ‚Äî {{.Amount}}</li>
                {{end}}
              </ul>
            </div>
          {{else}}
            <div class="muted" style="margin-top:8px;">No wagers yet.</div>
          {{end}}
        </label>
      {{end}}
    </div>

    {{if .Content.ExternalURL}}
      <p><a href="{{.Content.ExternalURL}}" target="_blank" rel="noopener">External link ‚Üó</a></p>
    {{end}}

    {{if and $.Content.CanWager (not $.Content.AlreadyClosed)}}
      <div class="wager-box">
        <div class="amount-input-wrap">
          <div style="flex:1; min-width:220px;">
            <label for="amount" style="font-weight:600; display:block; margin-bottom:6px;">Amount to wager</label>
            <input id="amount" name="amount" type="number" min="1" max="{{.Content.MaxStake}}" placeholder="ü¶∂ PiedPi√®ces" required>
            <div class="pill info-pill" style="margin-top:8px; display:inline-flex; align-items:center; gap:6px;">
              Max: ü¶∂ <span id="maxStake">{{.Content.MaxStake}}</span> PiedPi√®ces available
            </div>
          </div>
          <div class="wager-actions" style="align-items:flex-start;">
            <button id="submitBtn" class="primary">Place wager</button>
            <a class="pill" href="/bets/{{.Content.BetID}}">Cancel</a>
          </div>
        </div>
        <input type="range" id="amountSlider" class="wager-slider" min="0" max="{{.Content.MaxStake}}" value="0" {{if eq .Content.MaxStake 0}}disabled{{end}}>
        <input type="hidden" name="idempotency_key" id="idemp" value="{{.Content.IdempotencyKey}}">
        <p class="muted" style="margin:4px 0 0;">Use the slider or the field to choose how many ü¶∂ PiedPi√®ces go into escrow.</p>
        {{if eq .Content.MaxStake 0}}
          <p class="muted" style="color:#fca5a5; margin-top:4px;">You currently have no free PiedPi√®ces to wager.</p>
        {{end}}
      </div>
    {{else if .Header.LoggedIn}}
      {{if .Content.AlreadyClosed}}
        <p class="muted">This bet is closed.</p>
      {{else if or .Content.WaitingForConsensus .Content.WaitingForAdmin}}
        <p class="muted">Wagering paused while the bet is {{.Content.StatusLabel}}.</p>
      {{else}}
        <p class="muted">You can‚Äôt place a wager right now.</p>
      {{end}}
    {{else}}
      <p class="muted">Please log in to place a wager.</p>
    {{end}}
  </form>
{{end}}
{{if and (eq .Content.StatusLabel "Closed") .Content.Payouts}}
  <h3>Payouts</h3>
  <ul>
    {{range .Content.Payouts}}
      <li>{{if .Username}}<a href="/profile/{{.Username}}">{{.Name}}</a>{{else}}{{.Name}}{{end}} ‚Äî ü¶∂ +{{.Amount}} PiedPi√®ces</li>
    {{end}}
  </ul>
{{end}}

  <div class="row" style="margin-top:12px">
    <a class="pill" href="/bets/new">Create another</a>
    <a class="pill" href="/">Back home</a>
  </div>

  <script>
    // Make clicking the whole card check the radio (label+input already handles it).
    // Enforce max, sync slider/field, and prevent double-submit.
    (function(){
      const form   = document.getElementById('wagerForm');
      const amount = document.getElementById('amount');
      const submit = document.getElementById('submitBtn');
      const slider = document.getElementById('amountSlider');
      const maxNode = document.getElementById('maxStake');
      const maxVal = parseInt((maxNode && maxNode.textContent) || (amount && amount.max) || (slider && slider.max) || '0', 10) || 0;

      const clamp = (val) => {
        if (!maxVal) {
          return 0;
        }
        if (val > maxVal) return maxVal;
        if (val < 1) return 1;
        return val;
      };

      const setSubmit = (enabled, reason) => {
        if (!submit) return;
        submit.disabled = !enabled;
        if (!enabled && reason) {
          submit.dataset.disabledReason = reason;
          submit.title = reason;
        } else {
          if (submit.dataset.disabledReason) {
            delete submit.dataset.disabledReason;
          }
          submit.removeAttribute('title');
        }
      };

      if (maxVal === 0 && submit) {
        setSubmit(false, 'You have no free ü¶∂ PiedPi√®ces available.');
      }

      if (slider && amount) {
        slider.addEventListener('input', () => {
          if (maxVal === 0) {
            slider.value = '0';
            amount.value = '';
            setSubmit(false, 'You have no free ü¶∂ PiedPi√®ces available.');
            return;
          }
          let val = parseInt(slider.value, 10) || 0;
          if (val === 0) {
            amount.value = '';
            setSubmit(false, 'Move the slider above 0 PiedPi√®ces.');
            return;
          }
          val = clamp(val);
          slider.value = String(val);
          amount.value = String(val);
          setSubmit(true);
        });
      }

      if (amount) {
        amount.addEventListener('input', () => {
          if (maxVal === 0) {
            amount.value = '';
            if (slider) slider.value = '0';
            setSubmit(false, 'You have no free ü¶∂ PiedPi√®ces available.');
            return;
          }
          let val = parseInt(amount.value, 10) || 0;
          if (val <= 0) {
            amount.value = '';
            if (slider) slider.value = '0';
            setSubmit(false, 'Enter at least 1 PiedPi√®ce.');
            return;
          }
          val = clamp(val);
          amount.value = String(val);
          if (slider) slider.value = String(val);
          setSubmit(true);
        });
      }

      if (form && submit) {
        form.addEventListener('submit', (e)=>{
          if (submit.dataset.busy === "1") { e.preventDefault(); return; }
          submit.dataset.busy = "1";
          submit.disabled = true;
        });
      }
    })();
  </script>
{{end}}
