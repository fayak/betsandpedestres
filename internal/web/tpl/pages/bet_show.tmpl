{{define "bet_show"}}
  {{template "base" .}}
{{end}}

{{define "content"}}
  <h1>{{.Content.Title}}</h1>
  <p class="muted">Created by {{.Content.CreatorName}}</p>

  {{if .Content.Description}}
    <p style="white-space:pre-wrap">{{.Content.Description}}</p>
  {{end}}

  {{if .Content.Deadline}}
    <p class="muted">Deadline: <span class="dt" data-iso="{{.Content.Deadline.UTC.Format "2006-01-02T15:04:05Z07:00"}}"></span></p>
  {{end}}

  <h3>Pick an outcome</h3>


{{if .Content.ResolutionMode}}
  <div class="pill" style="background:#1f2937; border:1px solid #b91c1c">
    ‚ö†Ô∏è <b>Moderator action:</b> Selecting the winning outcome will finalize payouts to winners
    once a consensus is reached. Double-check the result and be honest.
  </div>

  <form method="POST" action="/bets/{{.Content.BetID}}/resolve" style="display:grid; gap:16px; max-width:860px; margin-top:12px">
    <div class="opt-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
      {{range .Content.Options}}
        <label class="opt-card" style="border:1px solid #b91c1c; border-radius:12px; padding:12px; display:block; cursor:pointer; background:#13151a;">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <div style="font-weight:600">{{.Label}}</div>
            <input type="radio" name="option_id" value="{{.ID}}" required>
          </div>
          <div class="row" style="gap:10px; margin-top:6px; flex-wrap:wrap;">
            <span class="pill">üí∞ Stakes: {{.Stakes}}</span>
            <span class="pill">Ratio: {{.Ratio}}</span>
          </div>
          {{if .Bettors}}
            <div style="margin-top:8px;">
              <div class="muted" style="margin-bottom:4px">Bettors (by amount):</div>
              <ul style="margin:0; padding-left:18px;">
                {{range .Bettors}}
                  <li>{{.Name}} ‚Äî {{.Amount}}</li>
                {{end}}
              </ul>
            </div>
          {{end}}
        </label>
      {{end}}
    </div>

    <div class="row" style="gap:8px">
      <button class="primary" style="background:#ef4444">Confirm outcome</button>
      <a class="pill" href="/bets/{{.Content.BetID}}">Cancel</a>
    </div>
  </form>

{{else}}

  <form id="wagerForm" method="POST" action="/bets/{{.Content.BetID}}/wagers" style="display:grid; gap:16px; max-width:860px">
    <div class="opt-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
      {{range .Content.Options}}
        <label class="opt-card" style="border:1px solid #2a2e39; border-radius:12px; padding:12px; display:block; cursor:pointer; background:#13151a;">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <div style="font-weight:600">{{.Label}}</div>
            <input type="radio" name="option_id" value="{{.ID}}" required>
          </div>
          <div class="row" style="gap:10px; margin-top:6px; flex-wrap:wrap;">
            <span class="pill">üí∞ Stakes: {{.Stakes}}</span>
            <span class="pill">Ratio: {{.Ratio}}</span>
          </div>
          {{if .Bettors}}
            <div style="margin-top:8px;">
              <div class="muted" style="margin-bottom:4px">Bettors (by amount):</div>
              <ul style="margin:0; padding-left:18px;">
                {{range .Bettors}}
                  <li>{{.Name}} ‚Äî {{.Amount}}</li>
                {{end}}
              </ul>
            </div>
          {{else}}
            <div class="muted" style="margin-top:8px;">No wagers yet.</div>
          {{end}}
        </label>
      {{end}}
    </div>

    {{if .Content.ExternalURL}}
      <p><a href="{{.Content.ExternalURL}}" target="_blank" rel="noopener">External link ‚Üó</a></p>
    {{end}}

    {{if .Content.CanWager}}
      <div style="display:grid; gap:10px; max-width:420px; margin-top:8px;">
        <label>
          <div>Amount (max: <span id="maxStake">{{.Content.MaxStake}}</span>)</div>
          <input id="amount" name="amount" type="number" min="1" max="{{.Content.MaxStake}}" required>
        </label>
        <input type="hidden" name="idempotency_key" id="idemp" value="{{.Content.IdempotencyKey}}">
        <div class="row" style="gap:8px;">
          <button id="submitBtn" class="primary">Place wager</button>
          <a class="pill" href="/bets/{{.Content.BetID}}">Cancel</a>
        </div>
        <p class="muted">Submitting will lock the amount into this bet‚Äôs escrow.</p>
      </div>
    {{else}}
      <p class="muted">Please log in to place a wager.</p>
    {{end}}
  {{if and .Content.IsModerator (not .Content.AlreadyClosed)}}
  <div class="row" style="margin:12px 0">
    <a class="pill" style="background:#3b82f6" href="/bets/{{.Content.BetID}}?mode=resolve">Close the bet and select the outcome</a>
  </div>
{{end}}
  </form>
{{end}}

  <div class="row" style="margin-top:12px">
    <a class="pill" href="/bets/new">Create another</a>
    <a class="pill" href="/">Back home</a>
  </div>

  <script>
    // Make clicking the whole card check the radio (label+input already handles it).
    // Enforce max and prevent double-submit.
    (function(){
      const f  = document.getElementById('wagerForm');
      const a  = document.getElementById('amount');
      const b  = document.getElementById('submitBtn');
      if (a && b && f) {
        const mx = parseInt(document.getElementById('maxStake').textContent || '0', 10) || 0;
        a.addEventListener('input', ()=> {
          if (a.value) {
            let v = parseInt(a.value,10)||0;
            if (v > mx) v = mx;
            if (v < 1)  v = 1;
            a.value = v;
          }
        });
        f.addEventListener('submit', (e)=>{
          if (b.dataset.busy === "1") { e.preventDefault(); return; }
          b.dataset.busy = "1"; b.disabled = true;
        });
      }
    })();
  </script>
{{end}}

