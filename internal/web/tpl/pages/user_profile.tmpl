{{define "user_profile"}}
  {{template "base" .}}
{{end}}

{{define "content"}}
  <h1>{{.Content.Title}}</h1>
  {{if .Content.ViewingOther}}
    <div class="pill strong" style="margin-bottom:12px; border-radius:10px;">
      You are viewing another user's profile.
    </div>
  {{end}}

  {{if .Content.ShowUserPicker}}
    <div class="accent-panel soft" style="margin-bottom:18px; padding:16px; border-radius:10px; border:1px solid #1f2636;">
      <label>
        <div style="margin-bottom:6px;">Jump to another profile</div>
        <select onchange="if(this.value) window.location = '/profile/' + this.value;">
          <option value="">Select a userâ€¦</option>
          {{range .Content.UserOptions}}
            <option value="{{.Username}}" {{if eq $.Content.Target.Username .Username}}selected{{end}}>{{.DisplayName}} ({{.Username}})</option>
          {{end}}
        </select>
      </label>
    </div>
  {{end}}

  <section class="accent-panel card-strip" style="display:grid; gap:16px; margin-bottom:24px; border-radius:12px; border:1px solid #1c2231; padding:20px;">
    <div style="border:1px solid #262c3f; border-radius:10px; padding:16px; background:rgba(13,16,24,0.9);">
      <h2 style="margin-top:0; letter-spacing:.05em; text-transform:uppercase; font-size:1rem; color:var(--accent-2);">Account</h2>
      <div class="row" style="flex-wrap:wrap; gap:12px;">
        <span class="pill">Username: <strong>{{.Content.Target.Username}}</strong></span>
        <span class="pill">Display name: <strong>{{.Content.Target.DisplayName}}</strong></span>
        <span class="pill">Role: <strong>{{.Content.Target.Role}}</strong></span>
        <span class="pill">Joined: <span class="dt" data-iso="{{.Content.Target.JoinedAt.UTC.Format "2006-01-02T15:04:05Z07:00"}}"></span></span>
      </div>
      {{if eq .Content.RoleUpdateStatus "updated"}}
        <div class="pill strong" style="margin:12px 0;">Role updated.</div>
      {{end}}
      {{if .Content.CanEditRoles}}
        <form method="POST" action="/profile/{{.Content.Target.Username}}" class="row" style="gap:12px; align-items:flex-end; flex-wrap:wrap; margin-top:12px;">
          <label>
            <div>Set role</div>
            <select name="role">
              <option value="unverified" {{if eq .Content.Target.Role "unverified"}}selected{{end}}>Unverified</option>
              <option value="user" {{if eq .Content.Target.Role "user"}}selected{{end}}>User</option>
              <option value="moderator" {{if eq .Content.Target.Role "moderator"}}selected{{end}}>Moderator</option>
              <option value="admin" {{if eq .Content.Target.Role "admin"}}selected{{end}}>Admin</option>
            </select>
          </label>
          <button class="primary" style="border-radius:8px;">Update</button>
        </form>
      {{end}}
    </div>
    <div style="display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
      <div class="accent-panel soft" style="border-radius:10px; border:1px solid #1f2636; padding:16px;">
        <h2 style="margin-top:0; font-size:1rem; letter-spacing:.05em; text-transform:uppercase; color:var(--accent);">Wallet</h2>
        <p style="font-size:1.3em; margin:0;">
          ðŸ¦¶ {{.Content.Wallet.Balance}} PiedPiÃ¨ces
          {{if .Content.Wallet.Escrow}}
            <span class="muted" style="font-size:0.8em;">(+ {{.Content.Wallet.Escrow}} in escrow)</span>
          {{end}}
        </p>
        {{if eq .Content.TransferStatus "sent"}}
          <div class="pill strong" style="margin:10px 0;">Transfer sent successfully.</div>
        {{else if eq .Content.TransferStatus "missing"}}
          <div class="pill" style="margin:10px 0; border-color:#f87171; color:#fca5a5;">Pick a recipient.</div>
        {{else if eq .Content.TransferStatus "invalid"}}
          <div class="pill" style="margin:10px 0; border-color:#f87171; color:#fca5a5;">Enter a valid amount.</div>
        {{else if eq .Content.TransferStatus "unknown"}}
          <div class="pill" style="margin:10px 0; border-color:#f87171; color:#fca5a5;">Couldnâ€™t find that user.</div>
        {{else if eq .Content.TransferStatus "self"}}
          <div class="pill" style="margin:10px 0; border-color:#f87171; color:#fca5a5;">You canâ€™t send PiedPiÃ¨ces to yourself.</div>
        {{else if eq .Content.TransferStatus "notenough"}}
          <div class="pill" style="margin:10px 0; border-color:#f87171; color:#fca5a5;">Insufficient balance.</div>
        {{else if eq .Content.TransferStatus "error"}}
          <div class="pill" style="margin:10px 0; border-color:#f87171; color:#fca5a5;">Transfer failed. Try again later.</div>
        {{end}}
        {{if and (not .Content.ViewingOther) (gt (len .Content.UserOptions) 0)}}
          <form method="POST" action="/profile" data-no-pjax style="margin-top:14px; display:flex; flex-direction:column; gap:12px;">
            <input type="hidden" name="action" value="transfer">
            <label>
              <div>Recipient</div>
              <select name="recipient" required>
                <option value="">Select a userâ€¦</option>
                {{range .Content.UserOptions}}
                  {{if ne $.Content.Target.Username .Username}}
                    <option value="{{.Username}}">{{.DisplayName}} ({{.Username}})</option>
                  {{end}}
                {{end}}
              </select>
            </label>
            <label>
              <div>Amount</div>
              <input type="number" name="amount" min="1" max="{{.Content.Wallet.Balance}}" step="1" required {{if not .Content.Wallet.Balance}}disabled{{end}}>
            </label>
            <label>
              <div>Note <span class="muted">(shown publicly in the Ledger)</span></div>
              <textarea name="note" rows="2" maxlength="200" placeholder="Optional messageâ€¦" {{if not .Content.Wallet.Balance}}disabled{{end}}></textarea>
            </label>
            <button class="primary" style="border-radius:8px;" {{if not .Content.Wallet.Balance}}disabled{{end}}>Send PiedPiÃ¨ces</button>
            {{if not .Content.Wallet.Balance}}
              <div class="muted" style="font-size:0.85em;">You need PiedPiÃ¨ces available to send a gift.</div>
            {{end}}
          </form>
        {{else if not .Content.ViewingOther}}
          <div class="muted" style="margin-top:12px; font-size:0.85em;">Transfers will be available once your account is verified.</div>
        {{end}}
      </div>
      {{if .Content.ShowTelegram}}
        <div class="accent-panel soft" style="border-radius:10px; border:1px solid #1f2636; padding:16px;">
          <h2 style="margin-top:0; font-size:1rem; letter-spacing:.05em; text-transform:uppercase; color:var(--accent);">Telegram</h2>
          <p><strong>Chat ID:</strong>
            {{if .Content.Target.TelegramChatID}}
              {{.Content.Target.TelegramChatID}}
            {{else}}
              <span class="muted">&lt;none&gt;</span>
            {{end}}
          </p>
          <p><strong>Your user ID:</strong> <code>{{.Content.Target.ID}}</code></p>
          <p class="muted" style="display:flex; flex-direction:column; gap:8px;">
            Send this command to
            <a href="https://t.me/betsandpedestres_bot" target="_blank" rel="noopener">@betsandpedestres_bot</a>:
            <span style="display:inline-flex; align-items:center; gap:8px;">
              <span class="pill" style="background:#3b1f38; border:1px solid #f472b6; color:#fbd6ff; font-family:monospace;">
                /register {{.Content.Target.ID}}
              </span>
              <button type="button" class="pill" style="background:#f472b6; border:0; color:#1f1f1f;" onclick="copyRegisterCommand('{{.Content.Target.ID}}')">
                Copy
              </button>
            </span>
            <span id="copyNotice" class="muted" style="display:none;">Copied to clipboard âœ“</span>
            {{if not .Content.Target.TelegramChatID}}
              <span class="pill" style="border-color:#f97316; color:#fdba74;">No Telegram linked â€” you wonâ€™t be able to recover this account if you lose your password.</span>
            {{else}}
              {{if eq .Content.NotifyUpdateStatus "updated"}}
                <span class="pill strong">Notification preference saved.</span>
              {{else if eq .Content.NotifyUpdateStatus "error"}}
                <span class="pill" style="border-color:#f87171; color:#fca5a5;">Could not update notifications.</span>
              {{end}}
              <form method="POST" action="/profile" data-no-pjax class="row" style="flex-direction:column; gap:8px; align-items:flex-start;">
                <input type="hidden" name="action" value="notify">
                <label style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" name="enabled" {{if .Content.Target.TelegramNotify}}checked{{end}}>
                  <span>Send Telegram DM notifications (bets, wagers, comments)</span>
                </label>
                <button class="pill" style="border-radius:8px;">Save preference</button>
              </form>
            {{end}}
          </p>
        </div>
      {{end}}
    </div>
    {{if not .Content.ViewingOther}}
      <div class="accent-panel soft" style="border-radius:10px; border:1px solid #1f2636; padding:16px;">
        <h2 style="margin-top:0; font-size:1rem; letter-spacing:.05em; text-transform:uppercase; color:var(--accent);">Display name</h2>
        {{if eq .Content.DisplayUpdateStatus "updated"}}
          <div class="pill strong" style="margin-bottom:10px;">Display name updated.</div>
        {{else if eq .Content.DisplayUpdateStatus "missing"}}
          <div class="pill" style="margin-bottom:10px; border-color:#f97316; color:#fdba74;">Display name cannot be empty.</div>
        {{else if eq .Content.DisplayUpdateStatus "error"}}
          <div class="pill" style="margin-bottom:10px; border-color:#f87171; color:#fca5a5;">Could not update display name.</div>
        {{end}}
        <form method="POST" action="/profile" data-no-pjax class="row" style="flex-direction:column; gap:10px; align-items:flex-start;">
          <input type="hidden" name="action" value="display">
          <label style="width:100%;">
            <div>Display name</div>
            <input name="display_name" required maxlength="64" value="{{.Content.Target.DisplayName}}" style="width:100%;">
          </label>
          <button class="primary" style="border-radius:8px;">Update display name</button>
        </form>
      </div>
      <div class="accent-panel soft" style="border-radius:10px; border:1px solid #1f2636; padding:16px;">
        <h2 style="margin-top:0; font-size:1rem; letter-spacing:.05em; text-transform:uppercase; color:var(--accent);">Change password</h2>
        {{if eq .Content.PasswordUpdateStatus "updated"}}
          <div class="pill strong" style="margin-bottom:10px;">Password updated.</div>
        {{else if eq .Content.PasswordUpdateStatus "invalid"}}
          <div class="pill" style="margin-bottom:10px; border-color:#f87171; color:#fca5a5;">Current password incorrect.</div>
        {{else if eq .Content.PasswordUpdateStatus "mismatch"}}
          <div class="pill" style="margin-bottom:10px; border-color:#f87171; color:#fca5a5;">New passwords do not match.</div>
        {{else if eq .Content.PasswordUpdateStatus "weak"}}
          <div class="pill" style="margin-bottom:10px; border-color:#f87171; color:#fca5a5;">Password must be at least 6 characters.</div>
        {{else if eq .Content.PasswordUpdateStatus "missing"}}
          <div class="pill" style="margin-bottom:10px; border-color:#f87171; color:#fca5a5;">Please fill every field.</div>
        {{else if eq .Content.PasswordUpdateStatus "error"}}
          <div class="pill" style="margin-bottom:10px; border-color:#f87171; color:#fca5a5;">Could not update password. Try again later.</div>
        {{end}}
        <form method="POST" action="/profile" data-no-pjax class="row" style="flex-direction:column; gap:10px; align-items:flex-start;">
          <input type="hidden" name="action" value="password">
          <label style="width:100%;">
            <div>Current password</div>
            <input type="password" name="current_password" required autocomplete="current-password" style="width:100%;">
          </label>
          <label style="width:100%;">
            <div>New password</div>
            <input type="password" name="new_password" required autocomplete="new-password" style="width:100%;">
          </label>
          <label style="width:100%;">
            <div>Confirm new password</div>
            <input type="password" name="confirm_password" required autocomplete="new-password" style="width:100%;">
          </label>
          <button class="primary" style="border-radius:8px;">Update password</button>
        </form>
      </div>
    {{end}}
  </section>

  <section class="accent-panel card-strip" style="margin-bottom:24px; padding:20px; border-radius:12px; border:1px solid #1c2231;">
    <h2 style="margin-top:0; letter-spacing:.05em; text-transform:uppercase;">Active bets (created)</h2>
    {{if .Content.ActiveBets}}
      <div style="display:grid; gap:12px;">
        {{range .Content.ActiveBets}}
          <div style="border:1px solid #252b3b; border-radius:10px; padding:12px; background:rgba(11,13,20,0.85);">
            <div class="row" style="justify-content:space-between; gap:12px;">
              <strong><a href="/bets/{{.ID}}">{{.Title}}</a></strong>
              <span class="muted">Created <span class="dt" data-iso="{{.CreatedAt.UTC.Format "2006-01-02T15:04:05Z07:00"}}"></span></span>
            </div>
            <div class="muted" style="margin-top:6px;">
              ðŸ¦¶ PiedPiÃ¨ces: {{.Stakes}} Â· Deadline:
              {{if .Deadline}}<span class="dt" data-iso="{{.Deadline.UTC.Format "2006-01-02T15:04:05Z07:00"}}"></span>{{else}}â€”{{end}}
            </div>
          </div>
        {{end}}
      </div>
    {{else}}
      <p class="muted">No active bets right now.</p>
    {{end}}
  </section>

  <section class="accent-panel card-strip" style="margin-bottom:24px; padding:20px; border-radius:12px; border:1px solid #1c2231;">
    <h2 style="margin-top:0; letter-spacing:.05em; text-transform:uppercase;">Active wagers</h2>
    {{if .Content.ActiveWagers}}
      <div style="display:grid; gap:12px;">
        {{range .Content.ActiveWagers}}
          <div style="border:1px solid #252b3b; border-radius:10px; padding:12px; display:flex; justify-content:space-between; gap:12px; background:rgba(11,13,20,0.85);">
            <div>
              <strong><a href="/bets/{{.BetID}}">{{.BetTitle}}</a></strong>
              <div class="muted">Deadline: {{if .Deadline}}<span class="dt" data-iso="{{.Deadline.UTC.Format "2006-01-02T15:04:05Z07:00"}}"></span>{{else}}â€”{{end}}</div>
            </div>
            <div><strong>ðŸ¦¶ {{.Amount}}</strong> PiedPiÃ¨ces</div>
          </div>
        {{end}}
      </div>
    {{else}}
      <p class="muted">No active wagers yet.</p>
    {{end}}
  </section>

  <section class="accent-panel card-strip" style="padding:20px; border-radius:12px; border:1px solid #1c2231;">
    <h2 style="margin-top:0; letter-spacing:.05em; text-transform:uppercase;">Recent transactions</h2>
    {{if .Content.Transactions}}
      <div style="overflow:auto; border:1px solid #252b3b; border-radius:10px;">
        <table style="width:100%; border-collapse:collapse; min-width:600px;">
          <thead>
            <tr style="text-align:left; background:rgba(13,16,24,0.9);">
              <th style="padding:10px; font-size:0.8rem; letter-spacing:.08em; text-transform:uppercase;">Date</th>
              <th style="padding:10px; font-size:0.8rem; letter-spacing:.08em; text-transform:uppercase;">Details</th>
              <th style="padding:10px; text-align:right; font-size:0.8rem; letter-spacing:.08em; text-transform:uppercase;">Amount</th>
            </tr>
          </thead>
          <tbody>
            {{range .Content.Transactions}}
              <tr style="border-top:1px solid #1f2636; background:rgba(8,9,15,0.6);">
                <td style="padding:10px;"><span class="dt" data-iso="{{.CreatedAt.UTC.Format "2006-01-02T15:04:05Z07:00"}}"></span></td>
                <td style="padding:10px;">
                  <div><strong>{{.Reason}}</strong>{{if .BetTitle}} Â· {{.BetTitle}}{{end}}</div>
                  {{if .Note}}<div class="muted">{{.Note}}</div>{{end}}
                </td>
                <td style="padding:10px; text-align:right; font-weight:bold; color:{{if gt .Delta 0}}#4ade80{{else}}#f87171{{end}};">
                  {{if gt .Delta 0}}+{{end}}{{.Delta}}
                </td>
              </tr>
            {{end}}
          </tbody>
        </table>
      </div>
    {{else}}
      <p class="muted">No transactions yet.</p>
    {{end}}
  </section>
  <script>
    function copyRegisterCommand(id){
      const command = `/register ${id}`;
      navigator.clipboard.writeText(command).then(()=>{
        const notice = document.getElementById('copyNotice');
        if(!notice) return;
        notice.style.display = 'inline';
        setTimeout(()=>notice.style.display = 'none', 2000);
      });
    }
  </script>
{{end}}
